global
    log /dev/log local0
    log /dev/log local1 notice
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    timeout connect 5s
    timeout client  1m
    timeout server  1m

frontend pg_write
    bind *:{{ pgsql_write_port }}
    mode tcp
    default_backend pg_leader

frontend pg_read
    bind *:{{ pgsql_read_port }}
    mode tcp
    default_backend pg_replica


backend pg_leader
    mode tcp
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 2s fall 3 rise 2

{% for db in pgsql_backends %}
    server {{ db.name }} {{ db.ip }}:{{ db.pg_port }} check port {{ patroni_rest_port }}
{% endfor %}


backend pg_replica
    mode tcp
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 2s fall 3 rise 2

{% for db in pgsql_backends %}
    server {{ db.name }} {{ db.ip }}:{{ db.pg_port }} check port {{ patroni_rest_port }}
{% endfor %}
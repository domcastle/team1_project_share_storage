---
########################################
# 1. 기본 시스템 설정
########################################

- name: Set timezone to Asia/Seoul
  command: timedatectl set-timezone Asia/Seoul
  changed_when: false

- name: Ensure chrony is installed
  dnf:
    name: chrony
    state: present

- name: Enable and start chrony
  systemd:
    name: chronyd
    state: started
    enabled: true

########################################
# 2. 필수 패키지 설치
########################################

- name: Install base packages
  dnf:
    name:
      - vim
      - git
      - curl
      - wget
      - net-tools
      - tcpdump
      - python3
      - rsync
    state: present

########################################
# 3. firewalld 비활성화 (초기 단계)
########################################

- name: Stop and disable firewalld
  systemd:
    name: firewalld
    state: stopped
    enabled: false
  ignore_errors: true

########################################
# 4. SELinux (초기 안정화용)
########################################

- name: Set SELinux to permissive (runtime)
  command: setenforce 0
  when: ansible_selinux.status == "enabled"
  ignore_errors: true

- name: Set SELinux to permissive (config)
  replace:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    replace: 'SELINUX=permissive'
  ignore_errors: true

########################################
# 5. SSH 기본 안정화 (절대 건드리지 말 것)
########################################

- name: Ensure SSH service is running
  systemd:
    name: sshd
    state: started
    enabled: true

########################################
# 6. 기본 디렉토리 구조
########################################

- name: Create base directories
  file:
    path: "{{ item }}"
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'
  loop:
    - /opt/apps
    - /opt/scripts
    - /var/log/apps

# ########################################
# # 7. DNS 설정 (Google DNS 고정)
# ########################################

# - name: Disable NetworkManager DNS management
#   file:
#     path: /etc/NetworkManager/NetworkManager.conf
#     section: main
#     option: dns
#     value: none
#   notify: Restart NetworkManager
#   ignore_errors: true

# - name: Remove existing resolv.conf if symlink
#   file:
#     path: /etc/resolv.conf
#     state: absent
#   when: ansible_facts['resolv_conf']['exists'] is defined
#   ignore_errors: true

# - name: Create resolv.conf with Google DNS
#   copy:
#     dest: /etc/resolv.conf
#     content: |
#       nameserver 8.8.8.8
#     owner: root
#     group: root
#     mode: '0644'

# - name: Make resolv.conf immutable
#   command: chattr +i /etc/resolv.conf
#   ignore_errors: true

- name: Configure DNS for redis servers
  import_tasks: dns.yml
  when: inventory_hostname == 'redis1'

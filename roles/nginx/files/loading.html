<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜ìƒ ìƒì„± ì¤‘</title>
  <link rel="stylesheet" href="css/style.css" />

  <style>
    body {
      background: #ffffff;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    /* ===============================
       ë¡œë”© ì˜ìƒ (spinner ëŒ€ì²´)
    =============================== */
    .loading-video {
      width: 160px;              /* â¬… ì‚´ì§ í‚¤ì›€ (120 â†’ 160) */
      margin-bottom: 24px;
    }

    .loading-video video {
      width: 100%;
      height: auto;
      display: block;
    }

    .message {
      font-size: 18px;           /* â¬… 16 â†’ 18 */
      font-weight: 500;
      letter-spacing: 0.02em;   /* ì€ì€í•œ ê³ ê¸‰ê° */
      margin-bottom: 8px;
    }

    .sub {
      font-size: 13px;
      color: #666;
      margin-bottom: 16px;
      text-align: center;
      line-height: 1.5;
    }

    /* ===============================
       Progress Bar
    =============================== */
    .progress-wrap {
      width: 240px;
      height: 6px;
      background: #eee;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #111;
      transition: width 0.6s ease;
    }

    .progress-text {
      margin-top: 8px;
      font-size: 12px;
      color: #666;
    }
  </style>

  <!-- âœ… íˆìŠ¤í† ë¦¬ì—ì„œ ë¡œë”© í˜ì´ì§€ ì œê±° -->
  <script>
    history.replaceState(null, "", location.href);
  </script>
</head>
<body>

  <!-- ğŸ”„ ë¡œë”© ì˜ìƒ -->
  <div class="loading-video">
    <video
      src="/videos/logo2.mp4"
      autoplay
      loop
      muted
      playsinline
    ></video>
  </div>

  <div class="message">ì˜ìƒ ìƒì„±ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤</div>
  <div class="sub">
    ë³´í†µ 1~2ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.<br />
    íƒ­ì„ ë‹«ì•„ë„ ì‘ì—…ì€ ê³„ì† ì§„í–‰ë¼ìš”.
  </div>

  <!-- ë¡œë”©ë°” -->
  <div class="progress-wrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-text" id="progressText">0%</div>

  <script>
    // ===============================
    // ì¸ì¦ ì²´í¬
    // ===============================
    const token = localStorage.getItem("access_token");
    if (!token) {
      window.location.href = "index.html";
    }

    // ===============================
    // URL íŒŒë¼ë¯¸í„°
    // ===============================
    const params = new URLSearchParams(window.location.search);
    const taskId = params.get("task_id");
    const model = params.get("model") || "video";

    if (!taskId) {
      window.location.href = "loading_error.html";
    }

    // ===============================
    // status API ìë™ ì„ íƒ
    // ===============================
    const STATUS_API =
      model === "video2"
        ? `/api/video2/status/${taskId}`
        : `/api/video/status/${taskId}`;

    // ===============================
    // polling ì„¤ì •
    // ===============================
    const POLL_INTERVAL = 15000;
    const MAX_WAIT = 5 * 60 * 1000;
    const startTime = Date.now();

    let intervalId = null;

    // ===============================
    // Fake Progress Bar (UXìš©)
    // ===============================
    let progress = 0;
    const bar = document.getElementById("progressBar");
    const text = document.getElementById("progressText");

    const progressTimer = setInterval(() => {
      const increment =
        progress < 30 ? Math.random() * 8 :
        progress < 60 ? Math.random() * 5 :
        progress < 85 ? Math.random() * 2 :
        Math.random() * 0.5;

      progress += increment;
      if (progress > 90) progress = 90;

      bar.style.width = `${progress.toFixed(0)}%`;
      text.textContent = `${progress.toFixed(0)}%`;
    }, 3000);

    // ===============================
    // ìƒíƒœ ì²´í¬
    // ===============================
    async function checkStatus() {
      try {
        const res = await fetch(STATUS_API, {
          headers: {
            "Authorization": `Bearer ${token}`,
          },
        });

        if (!res.ok) throw new Error();

        const data = await res.json();

        // âœ… ì™„ë£Œ
        if (data.status === "DONE") {
          clearInterval(intervalId);
          clearInterval(progressTimer);

          bar.style.width = "100%";
          text.textContent = "100%";

          setTimeout(() => {
            window.location.replace("loading_success.html");
          }, 3000);
          return;
        }

        // âŒ ì‹¤íŒ¨
        if (data.status === "FAILED") {
          clearInterval(intervalId);
          clearInterval(progressTimer);
          window.location.replace("loading_error.html");
          return;
        }

        // â± íƒ€ì„ì•„ì›ƒ
        if (Date.now() - startTime > MAX_WAIT) {
          clearInterval(intervalId);
          clearInterval(progressTimer);
          window.location.replace("loading_error.html");
        }

      } catch (e) {
        clearInterval(intervalId);
        clearInterval(progressTimer);
        window.location.replace("loading_error.html");
      }
    }

    // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
    checkStatus();

    // ì´í›„ polling
    intervalId = setInterval(checkStatus, POLL_INTERVAL);
  </script>

</body>
</html>

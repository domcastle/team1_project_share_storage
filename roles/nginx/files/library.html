<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Justic - Library</title>
<link rel="stylesheet" href="css/style.css">

<script>
  const token = localStorage.getItem("access_token");
  if (!token) location.href = "index.html";
</script>

<style>
.video-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ğŸ”¥ ì¸ë„¤ì¼ ë¸”ëŸ¬ ë°°ê²½ */
.image-bg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(28px);
  transform: scale(1.15);
  opacity: 0.45;
  z-index: 0;
  pointer-events: none;
}

/* ğŸ”¥ ì˜ìƒ ë¸”ëŸ¬ ë°°ê²½ */
.video-bg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: blur(28px);
  transform: scale(1.15);
  opacity: 0.45;
  z-index: 0;
  pointer-events: none;
  display: none;
}

.video-modal-center {
  width: 100%;
  display: flex;
  justify-content: center;
  position: relative;
  z-index: 1;
}

.video-modal-content { display: flex; gap: 36px; }
.short-card { display: flex; flex-direction: column; align-items: center; gap: 14px; }
.short-title {
  font-family: "Paperlogy", sans-serif;
  font-weight: 600;
  color: #fff;
  opacity: 0.95;
  text-align: center;

  /* ğŸ‘‡ ë°˜ì‘í˜• í°íŠ¸ í¬ê¸° */
  font-size: clamp(18px, 1.8vw, 24px);
  letter-spacing: 0.04em;
}

.short-video { width: 300px; aspect-ratio: 9/16; background:black; border-radius:14px; overflow:hidden; }
.short-video video { width:100%; height:100%; object-fit:cover; }

.youtube-btn {
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  background:#fff;
  border:1px solid #dadce0;
  border-radius:6px;
  padding:10px 16px;
  cursor:pointer;
}
.youtube-btn:hover { background:#f7f8f8; }
.youtube-icon { width:20px; height:20px; }

/* ===============================
   ì œëª© ì…ë ¥ ëª¨ë‹¬
================================ */
.title-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.title-box {
  background: #fff;
  padding: 24px;
  border-radius: 14px;
  width: 320px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.title-box h3 {
  margin: 0;
  font-size: 18px;
}

.title-box input {
  padding: 10px 12px;
  font-size: 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

.title-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

.title-actions button {
  padding: 8px 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

#confirmBtn {
  background: #000;
  color: #fff;
}

@media(max-width:900px){
  .video-modal-content{ flex-direction:column; align-items:center; }
}
</style>
</head>

<body>

<div class="top-menu">
  <div class="menu-btn" id="menuBtn"><span></span></div>
  <div class="menu-dropdown" id="menuDropdown">
    <a href="#" id="goMainBtn">ì˜ìƒ ìƒì„±í•˜ëŸ¬ ê°€ê¸°</a>
    <a href="#" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</a>
  </div>
</div>

<div class="library-container">

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ íƒ€ì´í‹€ ì´ë¯¸ì§€ -->
  <div class="library-header">
    <img
      src="/images/library.png"
      alt="ë¼ì´ë¸ŒëŸ¬ë¦¬"
      class="library-image"
    />
  </div>

  <div class="video-grid" id="videoGrid"></div>
</div>

<script>
const videoGrid = document.getElementById("videoGrid");

/* ë©”ë‰´ */
menuBtn.onclick = () => menuDropdown.classList.toggle("show");
logoutBtn.onclick = () => { localStorage.removeItem("access_token"); location.href="index.html"; };
goMainBtn.onclick = () => location.href="main.html";
document.addEventListener("click",e=>{
  if(!menuBtn.contains(e.target)&&!menuDropdown.contains(e.target))
    menuDropdown.classList.remove("show");
});

/* ì¸ë„¤ì¼ */
async function loadThumb(img, taskId){
  try{
    const res = await fetch(`/api/video/thumb/${taskId}.jpg`, {
      headers:{Authorization:`Bearer ${token}`}
    });
    img.src = URL.createObjectURL(await res.blob());
  }catch{
    img.src = "";
  }
}

/* ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ */
async function loadLibrary(){
  const res = await fetch("/api/video/list",{ headers:{Authorization:`Bearer ${token}`}});
  const data = await res.json();

  if(!data.videos.length){
    videoGrid.innerHTML = `
      <div class="empty-library">
        <div class="empty-main">ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</div>
        <div class="empty-sub" id="goCreate">ì˜ìƒ ìƒì„±í•˜ëŸ¬ ê°€ê¸°</div>
      </div>
    `;
    document.getElementById("goCreate").onclick = () => location.href="main.html";
    return;
  }

  data.videos.forEach(v=>{
    const card=document.createElement("div");
    card.className="video-card";

    const img=document.createElement("img");
    loadThumb(img,v.task_id);

    card.appendChild(img);
    card.onclick=()=>openPreview(v.task_id);
    videoGrid.appendChild(card);
  });
}

/* ì˜ìƒ fetch */
async function fetchVideo(taskId,type){
  const res = await fetch(`/api/video/stream/${taskId}?type=${type}`,{
    headers:{Authorization:`Bearer ${token}`}
  });
  if(!res.ok) throw new Error();
  return URL.createObjectURL(await res.blob());
}

/* ===========================
   ì œëª© ì…ë ¥ ëª¨ë‹¬ + ì—…ë¡œë“œ
=========================== */
function openTitleModal(taskId, type){
  const modal = document.createElement("div");
  modal.className = "title-modal";
  modal.innerHTML = `
    <div class="title-box">
      <h3>YouTube ì˜ìƒ ì—…ë¡œë“œ</h3>
      <input type="text" id="youtubeTitle" placeholder="ì˜ìƒ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
      <div class="title-actions">
        <button id="cancelBtn">ì·¨ì†Œ</button>
        <button id="confirmBtn">ì—…ë¡œë“œ</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector("#cancelBtn").onclick = () => modal.remove();

  modal.querySelector("#confirmBtn").onclick = async () => {
    const title = modal.querySelector("#youtubeTitle").value.trim();
    if(!title){
      alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    try{
      const res = await fetch("/api/video/upload/youtube",{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body: JSON.stringify({
          task_id: taskId,
          type: type,
          title: title
        })
      });
      if(!res.ok) throw new Error();
      alert("YouTube ì—…ë¡œë“œ ì™„ë£Œ! ì±„ë„ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”!");
      modal.remove();
    }catch{
      alert("YouTube ì±„ë„ì´ ì—†ê±°ë‚˜, ì—…ë¡œë“œì— ì‹¤íŒ¨ í•˜ì˜€ìŠµë‹ˆë‹¤.");
    }
  };
}

/* ì‡¼ì¸  ì¹´ë“œ ìƒì„± */
async function createShort(title,taskId,type){
  const wrap=document.createElement("div");
  wrap.className="short-card";

  const label=document.createElement("div");
  label.className="short-title";
  label.textContent=title;

  const box=document.createElement("div");
  box.className="short-video";

  const video=document.createElement("video");
  video.controls=true;

  try{
    video.src=await fetchVideo(taskId,type);
  }catch{
    label.textContent += " (ì—†ìŒ)";
  }

  box.appendChild(video);

  const btn=document.createElement("button");
  btn.className="youtube-btn";
  btn.innerHTML=`
    <img class="youtube-icon"
      src="https://upload.wikimedia.org/wikipedia/commons/f/fd/YouTube_full-color_icon_%282024%29.svg">
    <span class="youtube-text">ì—…ë¡œë“œ</span>
  `;
  btn.onclick = () => openTitleModal(taskId, type);

  wrap.append(label, box, btn);
  wrap._videoEl = video;
  wrap._type = type;
  return wrap;
}

/* ğŸ”¥ ë¯¸ë¦¬ë³´ê¸° (v2 í¬í•¨) */
async function openPreview(taskId){
  const modal=document.createElement("div");
  modal.className="video-modal";

  const imgBg=document.createElement("img");
  imgBg.className="image-bg";
  loadThumb(imgBg, taskId);

  const videoBg=document.createElement("video");
  videoBg.className="video-bg";
  videoBg.muted=true;
  videoBg.loop=true;
  videoBg.playsInline=true;

  const center=document.createElement("div");
  center.className="video-modal-center";

  const content=document.createElement("div");
  content.className="video-modal-content";

  const originalCard  = await createShort("Original", taskId, "original");
  const processedCard = await createShort("Edited v1", taskId, "processed");
  const processedV2   = await createShort("Edited v2", taskId, "processed_v2");

  [originalCard, processedCard, processedV2].forEach(card=>{
    const v = card._videoEl;
    const type = card._type;

    v.addEventListener("play", async ()=>{
      videoBg.src = await fetchVideo(taskId,type);
      videoBg.currentTime = v.currentTime;
      imgBg.style.display="none";
      videoBg.style.display="block";
      videoBg.play();
    });

    v.addEventListener("pause",()=>videoBg.pause());
    v.addEventListener("seeking",()=>videoBg.currentTime=v.currentTime);
  });

  content.append(originalCard, processedCard, processedV2);
  center.appendChild(content);
  modal.append(imgBg, videoBg, center);
  document.body.appendChild(modal);

  modal.onclick=()=>modal.remove();
  content.onclick=e=>e.stopPropagation();
}

loadLibrary();
</script>
</body>
</html>


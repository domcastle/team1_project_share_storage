import redis, json, subprocess, time

r = redis.Redis(
    host="{{ redis_host }}",
    port={{ redis_port }},
    decode_responses=True
)

QUEUE = "{{ video_queue_name }}"
STATUS = "{{ video_status_prefix }}"

SCRIPT = "/opt/ai/jobs/run_ffmpeg.sh"

while True:
    _, raw = r.brpop(QUEUE)
    job = json.loads(raw)

    job_id = job["job_id"]
    r.set(f"{STATUS}:{job_id}", "processing")

    try:
        subprocess.run(["bash", SCRIPT], check=True)
        r.set(f"{STATUS}:{job_id}", "done")
    except Exception:
        r.set(f"{STATUS}:{job_id}", "failed")

    time.sleep(1)

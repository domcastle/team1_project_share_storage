#!/bin/bash

REDIS_HOST="{{ redis_host }}"
REDIS_PORT="{{ redis_port }}"
REDIS_PASS="{{ redis_password }}"

QUEUE="video:queue"
WORKDIR="/opt/ai/jobs"

mkdir -p "$WORKDIR"

echo "[AI-WORKER] Started Redis worker loop"

while true; do
  JOB_ID=$(redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" \
    BRPOP "$QUEUE" 0 | tail -n 1)

  [ -z "$JOB_ID" ] && continue

  echo "[AI-WORKER] Got job: $JOB_ID"

  redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" \
    HSET "job:$JOB_ID" status processing started_at "$(date -Iseconds)"

  /opt/ai/process_video.sh "$JOB_ID"
  RESULT=$?

  if [ "$RESULT" -eq 0 ]; then
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" \
      HSET "job:$JOB_ID" status done finished_at "$(date -Iseconds)"
  else
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" -a "$REDIS_PASS" \
      HSET "job:$JOB_ID" status failed finished_at "$(date -Iseconds)"
  fi

done

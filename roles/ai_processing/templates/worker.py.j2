#!/usr/bin/env python3
import os
import json
import time
import tempfile
import subprocess

import redis
from minio import Minio

REDIS_HOST = os.getenv("REDIS_HOST", "10.1.1.10")
REDIS_PORT = int(os.getenv("REDIS_PORT", "6379"))
REDIS_QUEUE = os.getenv("REDIS_QUEUE", "video_processing_jobs")

MINIO_ENDPOINT = os.getenv("MINIO_ENDPOINT", "10.1.1.50:9000")
MINIO_ACCESS_KEY = os.getenv("MINIO_ACCESS_KEY", "justicadmin")
MINIO_SECRET_KEY = os.getenv("MINIO_SECRET_KEY", "justicadmin123")
MINIO_BUCKET = os.getenv("MINIO_BUCKET", "videos")

FFMPEG_SCRIPT = "/opt/ai/scripts/run_ffmpeg_shorts.sh"
CAPTION_SCRIPT = "/opt/ai/worker/generate_caption.py"

redis_client = redis.Redis(
    host=REDIS_HOST,
    port=REDIS_PORT,
    decode_responses=True,
)

minio = Minio(
    MINIO_ENDPOINT,
    access_key=MINIO_ACCESS_KEY,
    secret_key=MINIO_SECRET_KEY,
    secure=False,
)


def download_object(bucket, key, dst):
    obj = minio.get_object(bucket, key)
    with open(dst, "wb") as f:
        for c in obj.stream(1024 * 1024):
            f.write(c)
    obj.close()
    obj.release_conn()


def upload_object(bucket, key, src):
    minio.fput_object(bucket, key, src, content_type="video/mp4")


def process_job(job: dict):
    input_key = job["input_key"]
    output_key = job["output_key"]

    # ğŸ”‘ í•µì‹¬: variant (ê¸°ë³¸ v1)
    variant = job.get("variant", "v1")

    tmp_input = tempfile.NamedTemporaryFile(delete=False, suffix=".mp4").name
    tmp_output = tempfile.NamedTemporaryFile(delete=False, suffix=".mp4").name

    try:
        # 1ï¸âƒ£ ì›ë³¸ ë‹¤ìš´ë¡œë“œ
        download_object(MINIO_BUCKET, input_key, tmp_input)

        # 2ï¸âƒ£ LLM ìë§‰ ìƒì„± (variant ì „ë‹¬)
        env = os.environ.copy()
        env["CAPTION_VARIANT"] = variant

        caption = subprocess.check_output(
            ["python3", CAPTION_SCRIPT, tmp_input],
            text=True,
            timeout=600,
            env=env,              # ğŸ‘ˆ ì—¬ê¸° ì¤‘ìš”
        ).strip()

        if not caption:
            caption = "í¸ì§‘ëœ ì˜ìƒì…ë‹ˆë‹¤"

        print(f"ğŸ“ caption ({variant}) =", caption)

        # 3ï¸âƒ£ ffmpeg í¸ì§‘
        subprocess.run(
            [
                FFMPEG_SCRIPT,
                tmp_input,
                tmp_output,
                "",
                "",
                caption,
            ],
            check=True,
        )

        # 4ï¸âƒ£ ê²°ê³¼ ì—…ë¡œë“œ
        upload_object(MINIO_BUCKET, output_key, tmp_output)

    finally:
        for f in (tmp_input, tmp_output):
            if os.path.exists(f):
                os.remove(f)


def main():
    print("ğŸš€ AI Worker started")

    while True:
        _, raw = redis_client.brpop(REDIS_QUEUE)
        try:
            job = json.loads(raw)
            process_job(job)
        except Exception as e:
            print("âŒ job failed:", e)
        time.sleep(0.5)


if __name__ == "__main__":
    main()
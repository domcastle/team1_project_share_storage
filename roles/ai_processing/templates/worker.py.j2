#!/usr/bin/env python3
import os, json, time, subprocess
import redis
from minio import Minio

REDIS_HOST = os.getenv("REDIS_HOST", "10.1.1.10")
REDIS_PORT = int(os.getenv("REDIS_PORT", "6379"))

MINIO_ENDPOINT = os.getenv("MINIO_ENDPOINT", "10.1.1.50:9000")
MINIO_BUCKET = os.getenv("MINIO_BUCKET", "videos")
MINIO_ACCESS_KEY = os.getenv("MINIO_ACCESS_KEY")
MINIO_SECRET_KEY = os.getenv("MINIO_SECRET_KEY")

QUEUE = "video_processing_jobs"
FF = "/opt/ai/scripts/run_ffmpeg_shorts.sh"

r = redis.Redis(host=REDIS_HOST, port=REDIS_PORT, decode_responses=True)
m = Minio(
    MINIO_ENDPOINT,
    access_key=MINIO_ACCESS_KEY,
    secret_key=MINIO_SECRET_KEY,
    secure=False,
)

def download(obj, path):
    o = m.get_object(MINIO_BUCKET, obj)
    try:
        with open(path, "wb") as f:
            for c in o.stream(1024 * 1024):
                f.write(c)
    finally:
        o.close()
        o.release_conn()

def upload(obj, path):
    m.fput_object(MINIO_BUCKET, obj, path, content_type="video/mp4")

def main():
    while True:
        _, raw = r.blpop(QUEUE)
        job = json.loads(raw)

        task_id = job["task_id"]
        inp = job["input"]
        out = job["output"]

        local_input = f"/tmp/{task_id}_input.mp4"
        local_output = f"/tmp/{task_id}_output.mp4"

        try:
            download(inp, local_input)
            subprocess.run([FF, local_input, local_output], check=True)
            upload(out, local_output)
        finally:
            for p in (local_input, local_output):
                if os.path.exists(p):
                    try:
                        os.remove(p)
                    except:
                        pass

        time.sleep(1)

if __name__ == "__main__":
    main()

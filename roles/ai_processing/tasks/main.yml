---
###############################################################################
# 0. 기본 변수
###############################################################################
- name: Set ai worker vars
  set_fact:
    ai_base_dir: /opt/ai
    ai_scripts_dir: /opt/ai/scripts
    ai_user: ansible
    ai_group: ansible


###############################################################################
# 1. 시스템 패키지
###############################################################################
- name: Install system packages
  dnf:
    name:
      - python3
      - python3-pip
      - ffmpeg
      - espeak-ng
      - fontconfig
      - google-noto-sans-cjk-ttc-fonts
    state: present


###############################################################################
# 2. Python 패키지
###############################################################################
- name: Install python packages
  pip:
    name:
      - redis
      - minio
    executable: pip3


###############################################################################
# 3. 디렉토리 생성
###############################################################################
- name: Create ai directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
    mode: "0755"
  loop:
    - "{{ ai_base_dir }}"
    - "{{ ai_scripts_dir }}"

- name: Create ai worker directory
  file:
    path: /opt/ai/worker
    state: directory
    owner: ansible
    group: ansible
    mode: "0755"

###############################################################################
# 4. FFmpeg 스크립트 배포
###############################################################################
- name: Deploy ffmpeg script
  template:
    src: run_ffmpeg_shorts.sh.j2
    dest: "{{ ai_scripts_dir }}/run_ffmpeg_shorts.sh"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
    mode: "0755"


###############################################################################
# 5. worker.py 배포
###############################################################################
- name: Deploy ai worker
  template:
    src: worker.py.j2
    dest: "{{ ai_base_dir }}/worker.py"
    owner: "{{ ai_user }}"
    group: "{{ ai_group }}"
    mode: "0755"


###############################################################################
# 6. systemd 서비스 배포
###############################################################################
- name: Deploy ai-worker systemd service
  template:
    src: ai-worker.service.j2
    dest: /etc/systemd/system/ai-worker.service
    owner: root
    group: root
    mode: "0644"


###############################################################################
# 7. systemd reload & start
###############################################################################
- name: Reload systemd
  systemd:
    daemon_reload: yes

- name: Enable and start ai-worker
  systemd:
    name: ai-worker
    enabled: yes
    state: restarted

########################################
# 8. 폰트 설치
########################################
- name: Install font tools
  dnf:
    name:
      - unzip
      - wget
      - fontconfig
    state: present

- name: Create temp extract directory
  file:
    path: /tmp/paperlogy
    state: directory
    mode: "0755"

- name: Create system font directory
  file:
    path: /usr/share/fonts/paperlogy
    state: directory
    mode: "0755"

- name: Download Paperlogy font zip
  get_url:
    url: https://github.com/Freesentation/paperlogy/raw/refs/heads/main/Paperlogy-1.000.zip
    dest: /tmp/Paperlogy-1.000.zip
    mode: "0644"

- name: Unzip Paperlogy fonts
  unarchive:
    src: /tmp/Paperlogy-1.000.zip
    dest: /tmp/paperlogy
    remote_src: yes

# ✅ 구조 무관, 무조건 성공
- name: Copy all Paperlogy ttf fonts
  shell: |
    find /tmp/paperlogy -type f -iname "*.ttf" -exec cp {} /usr/share/fonts/paperlogy/ \;

- name: Rebuild font cache
  command: fc-cache -fv
  changed_when: false
########################################
# llm
########################################

- name: Install required system packages for ollama
  dnf:
    name:
      - zstd
      - curl
    state: present

- name: Check ollama binary exists
  stat:
    path: /usr/bin/ollama
  register: ollama_bin

- name: Install ollama (if not exists)
  shell: curl -fsSL https://ollama.com/install.sh | sh
  when: not ollama_bin.stat.exists

- name: Enable and start ollama service
  systemd:
    name: ollama
    enabled: yes
    state: started

- name: Wait for ollama API
  uri:
    url: http://127.0.0.1:11434
    method: GET
    status_code: 200
  register: ollama_api
  retries: 10
  delay: 3
  until: ollama_api.status == 200

########################################
# qwen2.5vl
########################################
- name: Check qwen2.5vl model exists
  shell: ollama list | grep -q "^qwen2.5vl"
  register: qwen_vl_exists
  failed_when: false
  changed_when: false

- name: Pull qwen2.5vl model (7b)
  shell: ollama pull qwen2.5vl:7b
  when: qwen_vl_exists.rc != 0




- name: Deploy generate_caption.py
  copy:
    src: generate_caption.py
    dest: /opt/ai/worker/generate_caption.py
    owner: ansible
    group: ansible
    mode: "0755"

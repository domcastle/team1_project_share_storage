---
- name: Common setup
  hosts: all
  become: true
  roles:
    - common
######################################################
# WEB-WAS Part
######################################################
- name: Nginx
  hosts: web
  become: true
  roles:
    - nginx

- name: Was
  hosts: was
  become: true
  roles:
    - was

- name: Redis1
  hosts: redis1
  become: true
  roles:
    - redis1
### AI
- name: Redis2
  hosts: redis2
  become: true
  roles:
    - role: redis2
      tags: redis2
######################################################
# DB part
######################################################  
- name: LB server
  hosts: pgsql_lb
  become: true

  roles:
    - haproxy_pgsql
    - keepalived

- name: db server 
  hosts: pgsql_db
  become: true
  roles:
    - etcd
    - postgresql
    - patroni
    - pgbackrest_client
    - postgres_oauth
    - postgres_ai


######################################################
# ai_worker
######################################################
- name: AI Processing
  hosts: ai_worker
  become: true
  roles:
    - role: ai_processing
      tags: ai_processing


######################################################
# DR
######################################################  
- name: Build DR-HA Patroni Replica (Remote DC)
  hosts: dr_ha
  become: true
  roles:
    - dr_ha

- name: DR Web + VIP Failover (keepalived)
  hosts: dr_ha
  become: true
  roles:
    - dr_web_static
    - dr_keepalived

########################################
# 1. Repo 서버 기본 준비
########################################
- name: Prepare repo server base
  hosts: dr_repo
  gather_facts: false
  roles:
    - repo_base

########################################
# 2. pgBackRest repo 설치 및 설정
########################################
- name: Install and configure pgBackRest on repo
  hosts: dr_repo
  gather_facts: false
  roles:
    - pgbackrest_repo

########################################
# 3. DB ↔ Repo SSH trust 구성
########################################
- name: Configure SSH trust (DB <-> Repo)
  hosts: pgsql_db:dr_repo
  gather_facts: false
  roles:
    - pg_ssh_trust

########################################
# 4. Repo postgres known_hosts 준비 (중요)
########################################
- name: Prepare postgres known_hosts on repo
  hosts: dr_repo
  gather_facts: false
  roles:
    - pg_ssh_known_hosts

########################################
# 5. DB 노드 pgBackRest client 설정
########################################
- name: Configure pgBackRest client on DB nodes
  hosts: pgsql_db
  gather_facts: false
  roles:
    - pgbackrest_client

########################################
# 6. pgBackRest stanza 생성 (repo, idempotent)
########################################
- name: Create pgBackRest stanza on repo
  hosts: dr_repo
  gather_facts: false
  roles:
    - pgbackrest_stanza

########################################
# 7. pgBackRest full backup 실행 (repo)
########################################
- name: Run pgBackRest full backup on repo
  hosts: dr_repo
  gather_facts: false
  roles:
    - pgbackrest_backup

######################################################
# Monitoring
######################################################
- name: Baseline (optional)
  hosts: all
  become: true
  roles:
    - node_exporter
    - promtail  

- name: Monitoring stack
  hosts: monitoring
  become: true
  roles:
    - prometheus
    - loki
    - grafana
